<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MiniMUD</title>
  <style>
    body {font-family: sans-serif; background-color: #000; color: #aaa }
    input { width: 100%; background-color: #444; color: #3f3; font-family: monospace; font-weight: bold; border-radius: 5px; padding: 5px; }
    .useract { color: #bbf; font-weight: bold }
    @media screen and (orientation: landscape) {
      div{ width: 800px; margin: 3px auto; }
    }
}  </style>
</head>
<body>

<div class="machine">
  <b>Hi there! Welcome to our virtual world.</b>
  <br/>
  I'll be your eyes and shall be telling whatever happens around.
  And you'll type in commands telling me what to do.
</div>

<div>
  <input type="text" id="command" placeholder="your command, master:"/>
</div>
<script>

var input = document.getElementById('command');

input.onkeydown = function() {
    if (event.key != 'Enter') return;
    var cmd = input.value.trim();
    if (cmd == '') return;
    addDiv('useract', cmd);
    sendCmd(cmd);
    input.value = '';
}

function addDiv(cls, text) {
    var div = document.createElement('div');
    div.classList.add(cls);
    div.innerText = text;
    document.body.insertBefore(div, input.parentElement);
    document.body.scrollTo(0, document.body.scrollHeight - document.body.clientHeight);
}

var commError = false;

function sendCmd(cmd) {
    nextEventCheck = new Date().getTime() + 4000 + Math.round(Math.random() * 3000);
    var m = location.href.match(/\?token\=([0-9a-zA-Z_\-]+)/);
    if (m === null) {
        respond('You need a magical token to communnicate to server!');
        return;
    }
    var token = m[1];
    var url = urlFromToken(m[1]);
    fetch(url, {
        method: 'POST', body: m[1] + '\n' + cmd
    }).then((resp) => {
        if (resp.status != 200) {
            if (!commError)
                respond('Sorry, exchange error: ' + resp.status);
            commError = true;
        } else {
            commError = false;
            resp.text().then((data) => respond(data));
        }
    }).catch((err) => {
        if (!commError)
            respond('Ah, oh, error: ' + err)
        commError = true;
    });
}

function respond(text) {
    if (text.trim() !== '')
        addDiv('machine', text);
}

function urlFromToken(token) {
    return atob(token.substr(27)).split(' ')[1];
}

var nextEventCheck = 0;

function eventsCheck() {
    var cur = new Date().getTime();
    if (nextEventCheck > cur)
        return;
    sendCmd('chkevt');
}

setInterval(eventsCheck, 1000 + Math.floor(Math.random()*100));
</script>
</body>
</html>
